<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>RAG System for Documents</title>

  <link rel="stylesheet" href="/static/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
  <header class="header">
    <h1>RAG System for Documents</h1>
    <p>Upload documents and ask questions based on their content</p>
  </header>

  <main class="main-grid">

    <section class="card">
      <h3>Document Management</h3>

      <div class="file-upload" id="fileUpload">
        <p class="hint">Drag file here or click to select</p>
        <p class="supported">Supported: PDF, DOCX, TXT, CSV, XLSX, HTML, JSON</p>
      </div>

      <input type="file" id="fileInput"
             accept=".pdf,.docx,.txt,.csv,.xlsx,.html,.json,.md">

      <input type="text" id="docName" placeholder="Document name (optional)">

      <button class="btn" id="uploadBtn" disabled>
        Upload Document
      </button>

      <div id="uploadStatus"></div>

      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-number" id="totalChunks">-</span>
          <span class="stat-label">Fragments</span>
        </div>

        <div class="stat-card">
          <span class="stat-number" id="totalDocs">-</span>
          <span class="stat-label">Documents</span>
        </div>

        <div class="stat-card">
          <span class="stat-number" id="avgTime">0.0s</span>
          <span class="stat-label">Avg Time</span>
        </div>
      </div>

      <button class="btn btn-secondary" id="refreshStats">
        Refresh Statistics
      </button>

      <button class="btn btn-danger" id="clearDb">
        Clear Database
      </button>
    </section>

    <section class="card">
      <h3>Ask Questions</h3>

      <div class="chat-container" id="chatContainer">
        <div class="message assistant">
          <div class="header">System</div>
          <div class="content">
            Welcome! Upload documents on the left and ask questions about their content.
            I will find the most relevant information and provide accurate answers.
          </div>
        </div>
      </div>

      <textarea id="questionInput" placeholder="Enter your question..."></textarea>

      <button class="btn" id="askBtn">
        Ask Question
      </button>

      <div id="questionStatus"></div>
    </section>

  </main>

  <script>
    
    let totalQuestions = 0;
    let totalTime = 0;

    const fileUpload = document.getElementById("fileUpload");
    const fileInput = document.getElementById("fileInput");
    const docName = document.getElementById("docName");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadStatus = document.getElementById("uploadStatus");

    const questionInput = document.getElementById("questionInput");
    const askBtn = document.getElementById("askBtn");
    const questionStatus = document.getElementById("questionStatus");
    const chatContainer = document.getElementById("chatContainer");

    const refreshStats = document.getElementById("refreshStats");
    const clearDb = document.getElementById("clearDb");

    const totalChunks = document.getElementById("totalChunks");
    const totalDocs = document.getElementById("totalDocs");
    const avgTime = document.getElementById("avgTime");

    document.addEventListener("DOMContentLoaded", () => {
      loadStats();
    });

    fileUpload.addEventListener("click", () => fileInput.click());

    ["dragover", "dragleave", "drop"].forEach((event) => {
      fileUpload.addEventListener(event, (e) => {
        e.preventDefault();
        fileUpload.classList.toggle("dragover", event === "dragover");

        if (event === "drop") {
          fileInput.files = e.dataTransfer.files;
          handleFileSelect();
        }
      });
    });

    fileInput.addEventListener("change", handleFileSelect);

    function handleFileSelect() {
      const file = fileInput.files[0];
      uploadBtn.disabled = !file;
      uploadBtn.textContent = file ? `Upload ${file.name}` : "Upload Document";
    }

    uploadBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("file", file);

      if (docName.value.trim()) {
        formData.append("document_name", docName.value.trim());
      }

      setLoading(uploadBtn, uploadStatus, "Processing document...");

      try {
        const res = await fetch("/api/upload", {
          method: "POST",
          body: formData,
        });

        const data = await safeJson(res);

        if (res.ok) {
          showStatus(uploadStatus, "success", data.message || "Uploaded!");
          fileInput.value = "";
          docName.value = "";
          handleFileSelect();
          setTimeout(loadStats, 500);
        } else {
          showStatus(uploadStatus, "error", data.detail || "Upload error");
        }
      } catch (e) {
        showStatus(uploadStatus, "error", e.message);
      } finally {
        resetLoading(uploadBtn, "Upload Document");
      }
    });

    askBtn.addEventListener("click", askQuestion);

    questionInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && e.ctrlKey) askQuestion();
    });

    async function askQuestion() {
      const question = questionInput.value.trim();
      if (!question) return;

      addMessage("user", question);

      askBtn.disabled = true;
      askBtn.classList.add("loading");
      askBtn.textContent = "Processing...";

      try {
        const res = await fetch("/api/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, n_results: 3 }),
        });

        const data = await safeJson(res);

        if (res.ok) {
          addMessage("assistant", data.answer, data.sources, data.processing_time);

          totalQuestions++;
          totalTime += data.processing_time;
          avgTime.textContent =
            (totalTime / totalQuestions).toFixed(1) + "s";

          questionInput.value = "";
        } else {
          showStatus(questionStatus, "error", data.detail || "Error");
        }
      } catch (e) {
        showStatus(questionStatus, "error", e.message);
      } finally {
        askBtn.disabled = false;
        askBtn.classList.remove("loading");
        askBtn.textContent = "Ask Question";
      }
    }

    function addMessage(type, content, sources = [], time = null) {
      const div = document.createElement("div");
      div.className = `message ${type}`;

      div.innerHTML = `
        <div class="header">${type === "user" ? "You" : "System"}</div>
        <div class="content">${content}</div>
        ${
          sources.length
            ? `<div class="sources">
                <strong>sources:</strong>
                ${sources
                  .map(
                    (s) =>
                      `${s.document} (${(s.similarity * 100).toFixed(1)}%)`
                  )
                  .join(", ")}
                ${time ? `<br><strong>time:</strong> ${time}s` : ""}
              </div>`
            : ""
        }
      `;

      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function loadStats() {
      try {
        const res = await fetch("/api/stats");
        const data = await safeJson(res);

        totalChunks.textContent = data.chunks ?? 0;
        totalDocs.textContent = data.documents ?? 0;
      } catch {
        totalChunks.textContent = "ERROR";
        totalDocs.textContent = "ERROR";
      }
    }

    refreshStats.addEventListener("click", loadStats);

    clearDb.addEventListener("click", async () => {
      if (!confirm("Clear knowledge base?")) return;

      try {
        const res = await fetch("/api/clear", { method: "DELETE" });
        const data = await safeJson(res);

        if (res.ok) {
          showStatus(uploadStatus, "success", data.message || "Cleared");

          chatContainer.innerHTML = `
            <div class="message assistant">
              <div class="header">System</div>
              <div class="content">Knowledge base cleared.</div>
            </div>
          `;

          totalChunks.textContent = "0";
          totalDocs.textContent = "0";
          avgTime.textContent = "0.0s";
          totalQuestions = 0;
          totalTime = 0;
        }
      } catch (e) {
        showStatus(uploadStatus, "error", e.message);
      }
    });

    function showStatus(el, type, msg) {
      el.innerHTML = `<div class="status ${type}">${msg}</div>`;
      if (type !== "loading") {
        setTimeout(() => (el.innerHTML = ""), 4000);
      }
    }

    function setLoading(button, statusEl, msg) {
      button.disabled = true;
      button.classList.add("loading");
      showStatus(statusEl, "loading", msg);
    }

    function resetLoading(button, text) {
      button.disabled = false;
      button.classList.remove("loading");
      button.textContent = text;
    }

    async function safeJson(res) {
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch {
        return { detail: text };
      }
    }

  </script>

</body>
</html>
