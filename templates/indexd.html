<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAG System for Documents - DEBUG</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    .debug-panel {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.9);
      color: #0f0;
      padding: 15px;
      border-radius: 8px;
      max-width: 400px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      z-index: 9999;
    }
    .debug-panel h4 {
      color: #0ff;
      margin: 0 0 10px 0;
    }
    .debug-log {
      margin: 5px 0;
      padding: 3px;
      border-left: 2px solid #0f0;
      padding-left: 5px;
    }
    .debug-error {
      border-left-color: #f00;
      color: #f00;
    }
    .debug-success {
      border-left-color: #0f0;
      color: #0f0;
    }
    .debug-info {
      border-left-color: #0ff;
      color: #0ff;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>RAG System for Documents</h1>
    <p>Upload documents and ask questions based on their content</p>
  </header>

  <main class="main-grid">
    <section class="card">
      <h3>Document Management</h3>

      <div class="file-upload" id="fileUpload">
        <p class="hint">Drag file here or click to select</p>
        <p class="supported">Supported: PDF, DOCX, TXT, CSV, XLSX, HTML, JSON</p>
      </div>

      <input type="file" id="fileInput" accept=".pdf,.docx,.txt,.csv,.xlsx,.html,.json,.md">
      <input type="text" id="docName" placeholder="Document name (optional)">
      <button class="btn" id="uploadBtn" disabled>Upload Document</button>
      <div id="uploadStatus"></div>

      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-number" id="totalChunks">-</span>
          <span class="stat-label">Fragments</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="totalDocs">-</span>
          <span class="stat-label">Documents</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="avgTime">0.0s</span>
          <span class="stat-label">Avg Time</span>
        </div>
      </div>

      <button class="btn btn-secondary" id="refreshStats">Refresh Statistics</button>
      <button class="btn btn-danger" id="clearDb">Clear Database</button>
    </section>

    <section class="card">
      <h3>Ask Questions</h3>

      <div class="chat-container" id="chatContainer">
        <div class="message assistant">
          <div class="header">System</div>
          <div class="content">
            Welcome! Upload documents on the left and ask questions about their content. I will find the most relevant information and provide accurate answers.
          </div>
        </div>
      </div>

      <textarea id="questionInput" placeholder="Enter your question..."></textarea>
      <button class="btn" id="askBtn">Ask Question</button>
      <div id="questionStatus"></div>
    </section>
  </main>

  <!-- DEBUG PANEL -->
  <div class="debug-panel" id="debugPanel">
    <h4>Debug Console</h4>
    <div id="debugLog"></div>
  </div>

  <script>
    // DEBUG LOGGER
    const debugLog = document.getElementById('debugLog');
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `debug-log debug-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      debugLog.appendChild(entry);
      debugLog.scrollTop = debugLog.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    log('Script loaded', 'success');
    
    let totalQuestions = 0;
    let totalTime = 0;

    const $ = (id) => {
      const el = document.getElementById(id);
      if (!el) log(`Element not found: ${id}`, 'error');
      return el;
    };

    const fileUpload = $("fileUpload");
    const fileInput = $("fileInput");
    const docName = $("docName");
    const uploadBtn = $("uploadBtn");
    const uploadStatus = $("uploadStatus");

    const questionInput = $("questionInput");
    const askBtn = $("askBtn");
    const questionStatus = $("questionStatus");
    const chatContainer = $("chatContainer");

    const refreshStats = $("refreshStats");
    const clearDb = $("clearDb");

    const totalChunks = $("totalChunks");
    const totalDocs = $("totalDocs");
    const avgTime = $("avgTime");

    log('All elements initialized', 'success');

    document.addEventListener("DOMContentLoaded", () => {
      log('DOM loaded', 'success');
      loadStats();
    });

    fileUpload.addEventListener("click", () => {
      log('File upload clicked', 'info');
      fileInput.click();
    });

    ["dragover", "dragleave", "drop"].forEach((event) => {
      fileUpload.addEventListener(event, (e) => {
        e.preventDefault();
        fileUpload.classList.toggle("dragover", event === "dragover");

        if (event === "drop") {
          log(`File dropped: ${e.dataTransfer.files[0]?.name}`, 'info');
          fileInput.files = e.dataTransfer.files;
          handleFileSelect();
        }
      });
    });

    fileInput.addEventListener("change", handleFileSelect);

    function handleFileSelect() {
      const file = fileInput.files[0];
      uploadBtn.disabled = !file;
      uploadBtn.textContent = file ? `Upload ${file.name}` : "Upload Document";
      if (file) log(`File selected: ${file.name} (${file.size} bytes)`, 'info');
    }

    uploadBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) {
        log('No file selected', 'error');
        return;
      }

      log(`Starting upload: ${file.name}`, 'info');

      const formData = new FormData();
      formData.append("file", file);

      const name = docName.value.trim();
      if (name) {
        formData.append("document_name", name);
        log(`Document name: ${name}`, 'info');
      }

      setLoading(uploadBtn, uploadStatus, "Processing document...");

      try {
        log('Sending POST to /api/upload', 'info');
        const res = await fetch("/api/upload", { method: "POST", body: formData });
        log(`Response status: ${res.status}`, res.ok ? 'success' : 'error');
        
        const data = await safeJson(res);
        log(`Response data: ${JSON.stringify(data)}`, 'info');

        if (res.ok) {
          showStatus(uploadStatus, "success", data.message || "Uploaded");
          log('Upload successful!', 'success');
          fileInput.value = "";
          docName.value = "";
          handleFileSelect();
          
          log('Refreshing stats in 1 second...', 'info');
          setTimeout(() => {
            log('Loading stats after upload', 'info');
            loadStats();
          }, 1000);
        } else {
          showStatus(uploadStatus, "error", data.detail || "Upload error");
          log(`Upload failed: ${data.detail}`, 'error');
        }
      } catch (e) {
        showStatus(uploadStatus, "error", e.message);
        log(`Upload error: ${e.message}`, 'error');
      } finally {
        resetLoading(uploadBtn, "Upload Document");
      }
    });

    askBtn.addEventListener("click", askQuestion);

    questionInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && e.ctrlKey) askQuestion();
    });

    async function askQuestion() {
      const question = questionInput.value.trim();
      if (!question) return;

      log(`Asking: ${question}`, 'info');
      addMessage("user", question);

      askBtn.disabled = true;
      askBtn.classList.add("loading");
      askBtn.textContent = "Processing...";

      try {
        const res = await fetch("/api/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, n_results: 3 }),
        });

        const data = await safeJson(res);

        if (res.ok) {
          log(`Answer received in ${data.processing_time}s`, 'success');
          addMessage("assistant", data.answer, data.sources, data.processing_time);

          totalQuestions++;
          totalTime += data.processing_time;
          avgTime.textContent = (totalTime / totalQuestions).toFixed(1) + "s";

          questionInput.value = "";
        } else {
          showStatus(questionStatus, "error", data.detail || "Error");
          log(`Question error: ${data.detail}`, 'error');
        }
      } catch (e) {
        showStatus(questionStatus, "error", e.message);
        log(`Question error: ${e.message}`, 'error');
      } finally {
        askBtn.disabled = false;
        askBtn.classList.remove("loading");
        askBtn.textContent = "Ask Question";
      }
    }

    function addMessage(type, content, sources = [], time = null) {
      const div = document.createElement("div");
      div.className = `message ${type}`;

      div.innerHTML = `
        <div class="header">${type === "user" ? "You" : "System"}</div>
        <div class="content">${content}</div>
        ${
          sources.length
            ? `<div class="sources">
                <strong>sources:</strong>
                ${sources
                  .map((s) => `${s.document} (${(s.similarity * 100).toFixed(1)}%)`)
                  .join(", ")}
                ${time ? `<br><strong>time:</strong> ${time}s` : ""}
              </div>`
            : ""
        }
      `;

      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function loadStats() {
      try {
        log('Fetching /api/stats...', 'info');
        const res = await fetch("/api/stats");
        log(`Stats response status: ${res.status}`, res.ok ? 'success' : 'error');
        
        if (!res.ok) {
          log(`Stats API error: ${res.status} ${res.statusText}`, 'error');
          totalChunks.textContent = "ERROR";
          totalDocs.textContent = "ERROR";
          return;
        }
        
        const data = await safeJson(res);
        log(`Stats data: ${JSON.stringify(data)}`, 'info');

        const chunks = data.chunks ?? 0;
        const documents = data.documents ?? 0;
        
        log(`Setting chunks=${chunks}, documents=${documents}`, 'success');
        
        totalChunks.textContent = chunks;
        totalDocs.textContent = documents;
        
      } catch (e) {
        log(`Stats error: ${e.message}`, 'error');
        totalChunks.textContent = "ERROR";
        totalDocs.textContent = "ERROR";
      }
    }

    refreshStats.addEventListener("click", () => {
      log('Manual stats refresh', 'info');
      loadStats();
    });

    clearDb.addEventListener("click", async () => {
      if (!confirm("Clear knowledge base?")) return;

      log('Clearing database...', 'info');

      try {
        const res = await fetch("/api/clear", { method: "DELETE" });
        const data = await safeJson(res);

        if (res.ok) {
          log('Database cleared', 'success');
          showStatus(uploadStatus, "success", data.message || "Cleared");
          chatContainer.innerHTML = "";
          totalChunks.textContent = "0";
          totalDocs.textContent = "0";
          totalQuestions = 0;
          totalTime = 0;
          avgTime.textContent = "0.0s";
          setTimeout(loadStats, 500);
        }
      } catch (e) {
        log(`Clear error: ${e.message}`, 'error');
        showStatus(uploadStatus, "error", e.message);
      }
    });

    function showStatus(el, type, msg) {
      el.innerHTML = `<div class="status ${type}">${msg}</div>`;
      if (type !== "loading") setTimeout(() => (el.innerHTML = ""), 4000);
    }

    function setLoading(button, statusEl, msg) {
      button.disabled = true;
      button.classList.add("loading");
      showStatus(statusEl, "loading", msg);
    }

    function resetLoading(button, text) {
      button.disabled = false;
      button.classList.remove("loading");
      button.textContent = text;
    }

    async function safeJson(res) {
      const text = await res.text();
      log(`Response text: ${text.substring(0, 200)}`, 'info');
      try {
        return JSON.parse(text);
      } catch (e) {
        log(`JSON parse error: ${e.message}`, 'error');
        return { detail: text };
      }
    }

    log('All event listeners attached', 'success');
  </script>
</body>
</html>